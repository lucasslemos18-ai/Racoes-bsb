<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fab. Rações BSB - Auditoria</title>
    
    <!-- Chamada da Biblioteca com Fallback -->
    <script src="https://cdnjs.cloudflare.com"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 15px; background: #f0f2f5; margin: 0; color: #1c1e21; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 12px; border-radius: 12px; border-top: 6px solid #cc0000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header img { height: 35px; width: auto; }
        .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        h3 { color: #cc0000; margin: 0 0 15px 0; font-size: 1.2em; border-bottom: 2px solid #f0f2f5; padding-bottom: 8px; text-transform: uppercase; }
        input[type="text"], select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f5f6f7; color: #1c1e21; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #ebedf0; }
        .item-row span { font-weight: 600; font-size: 1.05em; }
        input[type="checkbox"] { width: 30px; height: 30px; cursor: pointer; accent-color: #28a745; }
        .btn { width: 100%; padding: 20px; border: none; border-radius: 12px; color: #fff; font-weight: bold; font-size: 17px; margin: 10px 0; cursor: pointer; transition: background 0.3s; }
        .btn-save { background: #004a99; box-shadow: 0 4px #003366; }
        .btn-pdf { background: #28a745; box-shadow: 0 4px #1e7e34; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        #status-msg { text-align: center; font-weight: bold; color: #004a99; margin: 15px 0; font-size: 1.1em; }
        .loading-overlay { display: none; text-align: center; color: #cc0000; font-weight: bold; padding: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #cc0000; }
    </style>
</head>
<body>

<div class="header">
    <img src="https://upload.wikimedia.org" alt="JBS">
    <div style="font-weight: 900; color: #333; font-size: 0.8em; text-align: center; line-height: 1.2;">FAB. RAÇÕES<br>BSB</div>
    <img src="https://upload.wikimedia.org" alt="Seara">
</div>

<div class="card">
    <h3>1. Identificação</h3>
    <select id="input_area">
        <option value="" disabled selected>Escolha a Área (1 a 36)</option>
        <script>for(let i=1;i<=36;i++) document.write(`<option value="${i}">Área ${i}</option>`);</script>
    </select>
    <input type="text" id="input_resp" placeholder="Responsável da Área">
    <input type="text" id="input_aval" placeholder="Nome do Avaliador">
</div>

<div class="card">
    <h3>2. Checklist de Inspeção</h3>
    <div id="lista_itens"></div>
</div>

<div id="box_loading" class="loading-overlay">PROCESSANDO DADOS... POR FAVOR, AGUARDE.</div>

<button class="btn btn-save" id="btn_salvar_area" onclick="executarSalvamento()">SALVAR ÁREA ATUAL</button>
<button class="btn btn-pdf" onclick="iniciarGeracaoPDF()">GERAR PDF E WHATSAPP</button>

<div id="status-msg">Nenhuma área registrada.</div>

<script>
    const nomesDosItens = ["Piso", "Escadas", "Corrimãos", "Portas", "Iluminação", "Equipamentos", "Maquinas", "Organização/Limpeza", "Condição Insegura"];
    const memoriaLocal = [];

    // Montagem dinâmica dos itens
    const containerItens = document.getElementById('lista_itens');
    nomesDosItens.forEach(item => {
        containerItens.innerHTML += `
            <div class="item-row">
                <span style="${item==='Condição Insegura'?'color:#d93025;':''}">${item}</span>
                <input type="checkbox" class="campo-check" data-item="${item}">
            </div>
            <input type="file" accept="image/*" capture="camera" class="campo-foto" data-item="${item}" style="margin-bottom:8px; font-size:0.8em;">
            <input type="text" class="campo-obs" data-item="${item}" placeholder="Observações para ${item}..." style="margin-bottom:15px;">
        `;
    });

    // Função de tratamento de imagem otimizada para navegadores mobile
    const prepararImagem = (inputElement) => new Promise((resolve) => {
        if (!inputElement.files || !inputElement.files[0]) return resolve(null);
        const leitor = new FileReader();
        leitor.readAsDataURL(inputElement.files[0]);
        leitor.onload = (e) => {
            const imgObj = new Image();
            imgObj.src = e.target.result;
            imgObj.onload = () => {
                const canvasAux = document.createElement('canvas');
                const LARGURA_MAX = 700; 
                let w = imgObj.width;
                let h = imgObj.height;
                if (w > LARGURA_MAX) { h *= LARGURA_MAX / w; w = LARGURA_MAX; }
                canvasAux.width = w; canvasAux.height = h;
                canvasAux.getContext('2d').drawImage(imgObj, 0, 0, w, h);
                resolve(canvasAux.toDataURL('image/jpeg', 0.6));
            };
        };
        leitor.onerror = () => resolve(null);
    });

    async function executarSalvamento() {
        const area = document.getElementById('input_area').value;
        const resp = document.getElementById('input_resp').value;
        const aval = document.getElementById('input_aval').value;

        if(!area || !resp || !aval) {
            alert("⚠️ Atenção: Preencha Área, Responsável e Avaliador.");
            return;
        }

        document.getElementById('box_loading').style.display = 'block';
        document.getElementById('btn_salvar_area').disabled = true;

        const dadosDaArea = { area, resp, aval, data: new Date().toLocaleString('pt-BR'), nota: 100, detalhes: [] };
        
        const checks = document.querySelectorAll('.campo-check');
        const fotos = document.querySelectorAll('.campo-foto');
        const observacoes = document.querySelectorAll('.campo-obs');

        // Cálculo da Nota conforme regra
        let houveInseguranca = false;
        checks.forEach(c => { if(c.dataset.item === "Condição Insegura" && c.checked) houveInseguranca = true; });
        
        if(houveInseguranca) {
            dadosDaArea.nota = 0;
        } else {
            checks.forEach(c => { if(c.dataset.item !== "Condição Insegura" && !c.checked) dadosDaArea.nota -= 10; });
        }

        // Processamento de cada item
        for(let i=0; i < nomesDosItens.length; i++) {
            const base64Foto = await prepararImagem(fotos[i]);
            dadosDaArea.detalhes.push({
                nome: nomesDosItens[i],
                status: checks[i].checked ? "OK" : "PENDENTE",
                obs: observacoes[i].value || "N/A",
                imagem: base64Foto
            });
            // Limpar formulário
            checks[i].checked = false;
            observacoes[i].value = "";
            fotos[i].value = "";
        }

        memoriaLocal.push(dadosDaArea);
        document.getElementById('input_area').value = "";
        document.getElementById('box_loading').style.display = 'none';
        document.getElementById('btn_salvar_area').disabled = false;
        document.getElementById('status-msg').innerHTML = `✅ ÁREAS CONCLUÍDAS: ${memoriaLocal.length}`;
        
        alert(`Área ${area} arquivada com sucesso!`);
        window.scrollTo(0,0);
    }

    function iniciarGeracaoPDF() {
        if(memoriaLocal.length === 0) {
            alert("⚠️ Erro: Salve ao menos uma área antes de gerar o relatório.");
            return;
        }

        // TENTA ACESSAR A BIBLIOTECA DE 3 FORMAS DIFERENTES (COMPATIBILIDADE TOTAL)
        let PDFControl;
        try {
            if (window.jspdf && window.jspdf.jsPDF) {
                PDFControl = new window.jspdf.jsPDF();
            } else if (typeof jsPDF !== 'undefined') {
                PDFControl = new jsPDF();
            } else {
                throw new Error("Biblioteca não encontrada");
            }
        } catch (e) {
            alert("❌ Erro de Conexão: A biblioteca PDF não carregou. Tente atualizar a página ou verificar sua internet.");
            return;
        }

        try {
            // Página de Ranking
            PDFControl.setFontSize(20); PDFControl.setTextColor(200, 0, 0);
            PDFControl.text("FAB. RAÇÕES BSB - JBS / SEARA", 105, 20, {align:"center"});
            PDFControl.setFontSize(12); PDFControl.setTextColor(0);
            PDFControl.text("RANKING GERAL DE PERFORMANCE:", 20, 40);
            
            const ordenados = [...memoriaLocal].sort((a,b) => b.nota - a.nota);
            ordenados.forEach((item, index) => {
                PDFControl.text(`${index+1}º Área ${item.area}: ${item.nota}% (Avaliador: ${item.aval})`, 25, 52 + (index*10));
            });

            // Detalhamento
            memoriaLocal.forEach(areaDoc => {
                PDFControl.addPage();
                PDFControl.setFontSize(18); PDFControl.text(`DETALHES: ÁREA ${areaDoc.area}`, 10, 20);
                PDFControl.setFontSize(11); PDFControl.text(`Nota: ${areaDoc.nota}% | Responsável: ${areaDoc.resp} | Avaliador: ${areaDoc.aval}`, 10, 30);
                PDFControl.line(10, 35, 200, 35);
                
                let posicaoY = 45;
                areaDoc.detalhes.forEach(linha => {
                    PDFControl.setFontSize(10);
                    PDFControl.text(`${linha.status === 'OK' ? '[OK]' : '[  ]'} ${linha.nome}: ${linha.obs}`, 10, posicaoY);
                    if(linha.imagem) {
                        try { 
                            PDFControl.addImage(linha.imagem, 'JPEG', 145, posicaoY - 5, 45, 30); 
                            posicaoY += 25; 
                        } catch(errImg){}
                    }
                    posicaoY += 12;
                    if(posicaoY > 275) { PDFControl.addPage(); posicaoY = 20; }
                });
            });

            // Salva com timestamp para evitar conflito de nome no Android
            const nomeArquivo = `Auditoria_BSB_${new Date().getTime()}.pdf`;
            PDFControl.save(nomeArquivo);
            
            alert("✅ Relatório gerado! Verifique a pasta de Downloads do seu celular e compartilhe no WhatsApp.");

        } catch (erroGeral) {
            alert("Erro ao processar PDF: " + erroGeral.message);
        }
    }
</script>
</body>
</html>
