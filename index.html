<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fab. Rações BSB - Auditoria</title>
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f4f7f9; color: #333; margin: 0; }
        .header-logos { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; border-top: 6px solid #cc0000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-logos img { height: 30px; }
        .card { background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        h3 { color: #cc0000; margin: 0 0 12px 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; font-size: 1.1em; }
        .item-aval { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        input[type="checkbox"] { width: 32px; height: 32px; accent-color: #28a745; }
        input[type="text"], select { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
        .btn-acao { width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; color: white; }
        .save-btn { background: #004a99; }
        .final-btn { background: #28a745; }
        #status-ranking { font-weight: bold; color: #004a99; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header-logos">
    <img src="https://upload.wikimedia.org">
    <div style="font-weight: 900; color: #444; font-size: 0.75em; text-align: center;">FAB. RAÇÕES BSB</div>
    <img src="https://upload.wikimedia.org">
</div>

<div class="card">
    <h3>1. Identificação</h3>
    <label>Selecione a Área (1 a 36):</label>
    <select id="area" style="margin-bottom:10px;">
        <option value="" disabled selected>Escolha a Área...</option>
        <script>for(let i=1;i<=36;i++) document.write(`<option value="${i}">Área ${i}</option>`);</script>
    </select>
    <input type="text" id="responsavel_area" placeholder="Responsável da Área" style="margin-bottom:10px;">
    <input type="text" id="avaliador_nome" placeholder="Nome do Avaliador">
</div>

<div class="card">
    <h3>2. Itens de Inspeção</h3>
    <div id="checklist-container">
        <!-- Itens via JS para manter o HTML leve -->
    </div>
</div>

<button class="btn-acao save-btn" onclick="salvarArea()">SALVAR ÁREA ATUAL</button>
<button class="btn-acao final-btn" onclick="gerarPDF()">GERAR RELATÓRIO FINAL</button>

<div class="card" style="text-align:center;">
    <div id="status-ranking">Nenhuma área salva ainda.</div>
    <button onclick="location.reload()" style="background:none; border:none; color:gray; text-decoration:underline; margin-top:15px;">Limpar Tudo</button>
</div>

<script>
    const itensConfig = ["Piso", "Escadas", "Corrimãos", "Portas", "Iluminação", "Equipamentos", "Maquinas", "Organização/Limpeza", "Condição Insegura"];
    const bancoDeDados = [];

    // Renderizar Itens
    const container = document.getElementById('checklist-container');
    itensConfig.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item-aval';
        div.innerHTML = `
            <div class="row">
                <span style="${item === 'Condição Insegura' ? 'color:red; font-weight:bold;' : 'font-weight:600;'}">${item}</span>
                <input type="checkbox" class="check-item" data-name="${item}">
            </div>
            <input type="file" accept="image/*" capture="camera" class="foto-item" data-name="${item}" style="margin:10px 0;">
            <input type="text" class="obs-item" data-name="${item}" placeholder="Observações...">
        `;
        container.appendChild(div);
    });

    // Função para converter imagem de forma síncrona/prometida
    function processarFoto(input) {
        return new Promise((resolve) => {
            if (!input.files || !input.files[0]) return resolve(null);
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(input.files[0]);
        });
    }

    async function salvarArea() {
        const areaId = document.getElementById('area').value;
        const resp = document.getElementById('responsavel_area').value;
        const aval = document.getElementById('avaliador_nome').value;

        if (!areaId || !resp || !aval) {
            alert("⚠️ Preencha Área, Responsável e Avaliador!");
            return;
        }

        // Criar objeto da área
        const dadosArea = {
            id: areaId,
            responsavel: resp,
            avaliador: aval,
            data: new Date().toLocaleString('pt-BR'),
            itens: [],
            nota: 100
        };

        const checks = document.querySelectorAll('.check-item');
        const fotos = document.querySelectorAll('.foto-item');
        const obss = document.querySelectorAll('.obs-item');

        // Cálculo da Nota
        let condInsegura = false;
        checks.forEach(c => {
            if (c.dataset.name === "Condição Insegura" && c.checked) condInsegura = true;
        });

        if (condInsegura) {
            dadosArea.nota = 0;
        } else {
            checks.forEach(c => {
                if (c.dataset.name !== "Condição Insegura" && !c.checked) dadosArea.nota -= 10;
            });
        }

        // Coletar Dados dos Itens (Fotos são processadas aqui)
        for (let i = 0; i < itensConfig.length; i++) {
            const fotoBase64 = await processarFoto(fotos[i]);
            dadosArea.itens.push({
                nome: itensConfig[i],
                ok: checks[i].checked,
                obs: obss[i].value || "",
                foto: fotoBase64
            });
            
            // Limpar para o próximo
            checks[i].checked = false;
            obss[i].value = "";
            fotos[i].value = "";
        }

        bancoDeDados.push(dadosArea);
        
        // Reset campos topo
        document.getElementById('area').value = "";
        document.getElementById('status-ranking').innerHTML = `✅ Áreas Salvas: ${bancoDeDados.length}`;
        
        alert(`Área ${areaId} salva com sucesso!`);
        window.scrollTo(0,0);
    }

    async function gerarPDF() {
    if (bancoDeDados.length === 0) {
        alert("❌ Erro: Salve pelo menos uma área antes de gerar o PDF!");
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const dataAtual = new Date().toLocaleDateString('pt-BR');

        // PÁGINA 1: RANKING
        doc.setFontSize(18); doc.setTextColor(200, 0, 0);
        doc.text("FAB. RAÇÕES BSB - RANKING FINAL", 105, 20, {align:"center"});
        doc.setFontSize(10); doc.setTextColor(100);
        doc.text(`Relatório emitido em: ${dataAtual}`, 105, 28, {align:"center"});
        
        const sorted = [...bancoDeDados].sort((a,b) => b.nota - a.nota);
        doc.setFontSize(12); doc.setTextColor(0);
        doc.text("CLASSIFICAÇÃO POR NOTA:", 20, 45);
        
        sorted.forEach((a, i) => {
            const cor = a.nota < 70 ? [200, 0, 0] : [0, 100, 0];
            doc.setTextColor(cor[0], cor[1], cor[2]);
            doc.text(`${i+1}º Área ${a.id}: ${a.nota}% - Avaliador: ${a.avaliador}`, 25, 55 + (i*10));
        });

        // DETALHES POR ÁREA
        for (let area of bancoDeDados) {
            doc.addPage();
            doc.setTextColor(0);
            doc.setFontSize(16); doc.text(`DETALHES: ÁREA ${area.id}`, 10, 20);
            doc.setFontSize(10); doc.text(`Avaliador: ${area.avaliador} | Responsável: ${area.responsavel} | Data: ${area.data}`, 10, 28);
            doc.text(`PONTUAÇÃO FINAL: ${area.nota}%`, 10, 34);
            doc.line(10, 36, 200, 36);
            
            let y = 45;
            for (let it of area.itens) {
                doc.setFont("helvetica", "bold");
                doc.text(`${it.ok ? '[OK]' : '[  ]'} ${it.nome}`, 10, y);
                doc.setFont("helvetica", "normal");
                doc.text(`Obs: ${it.obs}`, 10, y + 5);
                
                if (it.foto) {
                    try {
                        // Reduz um pouco o tamanho da imagem para evitar erro de memória no PDF
                        doc.addImage(it.foto, 'JPEG', 140, y - 5, 50, 32); 
                        y += 25;
                    } catch(e) {
                        console.error("Erro ao incluir foto no PDF");
                    }
                }
                y += 12;
                if (y > 270) { doc.addPage(); y = 20; }
            }
        }

        // --- MUDANÇA CRÍTICA PARA IOS ---
        const pdfOutput = doc.output('blob');
        const filename = `Relatorio_Racoes_BSB_${dataAtual.replace(/\//g,'-')}.pdf`;
        const file = new File([pdfOutput], filename, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: 'Relatório Fab. Rações BSB',
                text: 'Segue o relatório de auditoria semanal.'
            });
        } else {
            // Caso o compartilhamento falhe, abre o PDF em uma nova aba (funciona no Safari)
            const url = URL.createObjectURL(pdfOutput);
            window.open(url, '_blank');
            alert("O compartilhamento nativo falhou, o PDF foi aberto em uma nova aba. Use o ícone de seta para enviar ao WhatsApp.");
        }

    } catch (error) {
        console.error(error);
        alert("Erro ao gerar PDF: " + error.message);
    }
}
</script>
</body>
</html>

