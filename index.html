<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vistoria Semanal Fab. Ra√ß√µes BSB</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 15px; background: #f0f2f5; color: #333; margin: 0; }
        .no-print { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 12px; border-top: 6px solid #cc0000; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header img { height: 35px; width: auto; max-width: 100px; object-fit: contain; }
        .card { background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h3 { color: #cc0000; margin: 0 0 10px 0; border-bottom: 2px solid #f0f2f5; padding-bottom: 8px; font-size: 1.1em; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .instrucao { font-size: 11px; color: #d93025; margin-bottom: 10px; font-weight: bold; }
        .btn-foto { background: #6c757d; color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-weight: bold; margin: 8px 0; cursor: pointer; }
        .preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 20px; }
        .thumb { width: 85px; height: 85px; object-fit: cover; border-radius: 10px; border: 3px solid #004a99; }
        .btn { display: block; width: 100%; padding: 20px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 17px; margin: 10px 0; cursor: pointer; text-align: center; text-decoration: none; box-sizing: border-box; }
        .btn-save { background: #004a99; }
        .btn-report { background: #28a745; }
        .btn-wa { background: #25D366; }
        #relatorio-view { display: none; background: white; padding: 20px; min-height: 100vh; }
        .ranking-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .ranking-table th, .ranking-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .ranking-table th { background: #cc0000; color: white; }
        .area-box { border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 25px; page-break-inside: avoid; }
        .foto-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .foto-resumo { width: 130px; height: 130px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
        @media print { .no-print { display: none !important; } #relatorio-view { display: block !important; } }
    </style>
</head>
<body>

<div id="main-ui" class="no-print">
    <div class="header">
        <img src="https://logodownload.org" alt="JBS">
        <div style="font-weight: 900; color: #444; font-size: 0.8em; text-align: center; line-height: 1.1;">VISTORIA SEMANAL<br>FAB. RA√á√ïES BSB</div>
        <img src="https://logodownload.org" alt="Seara">
    </div>

    <div class="card">
        <h3>1. Identifica√ß√£o</h3>
        <select id="area_sel">
            <option value="" disabled selected>Selecione a √Årea (1-36)</option>
            <script>for(let i=1;i<=36;i++)document.write(`<option value="${i}">√Årea ${i}</option>`);</script>
        </select>
        <input type="text" id="resp" placeholder="Respons√°vel da √Årea">
        <input type="text" id="aval" placeholder="Nome do Avaliador">
    </div>

    <div id="checklist-container"></div>

    <button class="btn btn-save" onclick="salvarArea()">SALVAR √ÅREA ATUAL</button>
    <button class="btn btn-report" onclick="mostrarRelatorio()">GERAR RELAT√ìRIO FINAL</button>
    <p id="contador" style="text-align:center; font-weight:bold; color:#004a99;"></p>
</div>

<div id="relatorio-view">
    <div style="text-align:center; border-bottom:4px solid #cc0000; padding-bottom: 15px; margin-bottom: 25px;">
        <h2 style="margin:0; color:#cc0000; text-transform: uppercase;">Relat√≥rio Vistoria Fab. Ra√ß√µes</h2>
        <p style="margin:5px 0; font-weight: bold; color: #666;">Emiss√£o: <span id="data-rel"></span></p>
    </div>
    <div id="corpo-ranking"></div>
    <div id="corpo-detalhes"></div>
    
    <button onclick="compartilharWA()" class="btn btn-wa no-print">ENVIAR RESUMO WHATSAPP</button>
    <button class="btn btn-save no-print" onclick="window.print()">SALVAR PDF COMPLETO</button>
    <button class="btn no-print" style="background:#000;" onclick="if(confirm('Zerar todos os dados?')) location.reload()">REINICIAR</button>
</div>

<script>
    const itens = ["Estruturas", "El√©trica", "Equipamentos", "Organiza√ß√£o 5S", "Condi√ß√£o Insegura"];
    const db = [];
    let fotosTemp = {};

    function initFotos() {
        itens.forEach(it => fotosTemp[it] = []);
    }
    initFotos();

    const container = document.getElementById('checklist-container');
    itens.forEach(it => {
        container.innerHTML += `
            <div class="card">
                <div class="item-row">
                    <span style="${it==='Condi√ß√£o Insegura' ? 'color:red;font-weight:bold' : ''}">${it}</span>
                    <input type="checkbox" class="c-check" data-n="${it}">
                </div>
                <p class="instrucao">${it === 'Condi√ß√£o Insegura' ? 'ZERA A NOTA' : 'FALHA: -10% NA NOTA'}</p>
                <button class="btn-foto" onclick="document.getElementById('in-${it}').click()">Ôºã FOTO</button>
                <input type="file" id="in-${it}" accept="image/*" capture="camera" style="display:none" onchange="processarFoto('${it}', this)">
                <div id="pre-${it}" class="preview"></div>
                <input type="text" class="c-obs" data-n="${it}" placeholder="Descreva a irregularidade...">
            </div>`;
    });

    function processarFoto(it, input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX = 800;
                let w = img.width, h = img.height;
                
                if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } }
                else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, w, h);
                
                const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                fotosTemp[it].push(dataUrl);
                
                const thumb = document.createElement('img');
                thumb.src = dataUrl; 
                thumb.className = 'thumb';
                document.getElementById('pre-' + it).appendChild(thumb);
            };
        };
        reader.readAsDataURL(file);
    }

    function salvarArea() {
        const area = document.getElementById('area_sel').value;
        const resp = document.getElementById('resp').value;
        const aval = document.getElementById('aval').value;
        
        if(!area || !resp || !aval) return alert("Preencha √Årea, Respons√°vel e Avaliador!");
        
        const dadosArea = { area, resp, aval, data: new Date().toLocaleString(), falhas: [] };
        const checks = document.querySelectorAll('.c-check');
        const obss = document.querySelectorAll('.c-obs');

        let temInsegura = false;
        let descontos = 0;

        checks.forEach((c, i) => {
            if(c.checked) {
                const nome = c.dataset.n;
                if(nome === "Condi√ß√£o Insegura") temInsegura = true;
                else descontos += 10;
                
                dadosArea.falhas.push({ 
                    nome, 
                    obs: obss[i].value, 
                    fotos: Array.from(fotosTemp[nome]) 
                });
            }
        });

        dadosArea.nota = temInsegura ? 0 : Math.max(0, 100 - descontos);
        db.push(dadosArea);

        // Reset Total
        document.getElementById('area_sel').value = "";
        document.getElementById('resp').value = "";
        checks.forEach(c => c.checked = false);
        obss.forEach(o => o.value = "");
        itens.forEach(it => {
            document.getElementById('pre-' + it).innerHTML = "";
            fotosTemp[it] = [];
        });

        alert(`√Årea ${area} salva com sucesso!`);
        document.getElementById('contador').innerText = `√Åreas salvas: ${db.length}`;
    }

    function mostrarRelatorio() {
        if(db.length === 0) return alert("Salve uma √°rea primeiro!");
        
        document.getElementById('main-ui').style.display = 'none';
        document.getElementById('relatorio-view').style.display = 'block';
        document.getElementById('data-rel').innerText = new Date().toLocaleString();

        let rankingHtml = `<table class="ranking-table"><tr><th>√Årea</th><th>Respons√°vel</th><th>Nota</th></tr>`;
        let detalhesHtml = "";

        db.sort((a,b) => a.area - b.area).forEach(d => {
            rankingHtml += `<tr><td>${d.area}</td><td>${d.resp}</td><td>${d.nota}%</td></tr>`;
            detalhesHtml += `<div class="area-box">
                <h3 style="background:#eee;padding:8px">üìç √Årea ${d.area} - üë§ ${d.resp} (Nota: ${d.nota}%)</h3>
                <p style="font-size:12px; color:#555; margin-bottom:10px;">üìù Avaliador: ${d.aval} | üìÖ ${d.data}</p>`;
                
            if(d.falhas.length === 0) {
                detalhesHtml += `<p style="color:green; font-weight:bold;">‚úì Conforme</p>`;
            } else {
                d.falhas.forEach(f => {
                    detalhesHtml += `
                    <div style="margin-top:10px; border-top:1px solid #ddd; padding-top:5px;">
                        <b style="${f.nome==='Condi√ß√£o Insegura'?'color:red':''}">‚ö†Ô∏è ${f.nome}</b><br>
                        <span>Obs: ${f.obs || 'N/A'}</span>
                        <div class="foto-grid">${f.fotos.map(img => `<img src="${img}" class="foto-resumo">`).join('')}</div>
                    </div>`;
                });
            }
            detalhesHtml += `</div>`;
        });
        
        document.getElementById('corpo-ranking').innerHTML = rankingHtml + "</table>";
        document.getElementById('corpo-detalhes').innerHTML = detalhesHtml;
        window.scrollTo(0,0);
    }

    function compartilharWA() {
        if (db.length === 0) return;
        
        const dataAgora = new Date().toLocaleString();
        let ranking = [...db].sort((a,b) => b.nota - a.nota).slice(0, 5);
        
        let txt = "üè≠ *VISTORIA SEMANAL RA√á√ïES BSB*\n";
        txt += `üìÖ *DATA:* ${dataAgora}\n`;
        txt += "----------------------------------------\n\n";
        
        txt += "üèÜ *TOP 5 AREAS (RANKING)*\n";
        const medalhas = ["ü•á", "ü•à", "ü•â", "üèÖ", "üèÖ"];
        ranking.forEach((d, i) => {
            txt += `${medalhas[i]} *${d.nota}%* - √Årea ${d.area} (${d.resp})\n`;
        });
        
        txt += "\nüìã *DETALHAMENTO DE PEND√äNCIAS*\n";
        txt += "----------------------------------------\n";
        
        let pendencias = db.filter(d => d.falhas.length > 0);
        if(pendencias.length === 0) {
            txt += "‚úÖ Todas as √°reas est√£o conformes!\n";
        } else {
            pendencias.forEach(d => {
                txt += `\nüìç *√Årea ${d.area}* (${d.nota}%)\n`;
                txt += `üë§ Resp: ${d.resp}\n`;
                txt += `üìù Aval: ${d.aval}\n`;
                txt += `üïí Hora: ${d.data.split(' ')[1]}\n`; // Pega apenas a hora da vistoria daquela √°rea
                d.falhas.forEach(f => {
                    txt += `‚ö†Ô∏è _${f.nome}_ ${f.obs ? '- ' + f.obs : ''}\n`;
                });
            });
        }

        const encodedTxt = encodeURIComponent(txt);
        const waLink = "whatsapp://send?text=" + encodedTxt;
        const webLink = "https://wa.me" + encodedTxt;
        
        window.location.href = waLink;
        setTimeout(() => {
            if (document.hasFocus()) { window.open(webLink, "_blank"); }
        }, 500);
    }
</script>
</body>
</html>
