<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fab. Rações BSB</title>
    <!-- Biblioteca jsPDF via CDN (essencial estar no topo) -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f7f9; }
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-top: 5px solid #cc0000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h3 { color: #cc0000; margin-top: 0; }
        input[type="text"], select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .item-aval { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        input[type="checkbox"] { width: 25px; height: 25px; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 16px; margin: 10px 0; }
        .btn-blue { background: #004a99; }
        .btn-green { background: #28a745; }
        #log { font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. Identificação</h3>
    <select id="area">
        <option value="" disabled selected>Área (1 a 36)</option>
        <script>for(let i=1;i<=36;i++) document.write(`<option value="${i}">Área ${i}</option>`);</script>
    </select>
    <input type="text" id="resp" placeholder="Responsável da Área">
    <input type="text" id="aval" placeholder="Nome do Avaliador">
</div>

<div class="card">
    <h3>2. Checklist</h3>
    <div id="itens-container"></div>
</div>

<button class="btn btn-blue" onclick="salvar()">SALVAR ÁREA</button>
<button class="btn btn-green" onclick="gerarPDF()">GERAR PDF / WHATSAPP</button>
<div id="log">Aguardando...</div>

<script>
    const itensNomes = ["Piso", "Escadas", "Corrimãos", "Portas", "Iluminação", "Equipamentos", "Maquinas", "Limpeza", "Condição Insegura"];
    const dadosGerais = [];

    // Gerar Itens
    const container = document.getElementById('itens-container');
    itensNomes.forEach(item => {
        container.innerHTML += `
            <div class="item-aval">
                <span style="${item==='Condição Insegura'?'color:red;font-weight:bold':''}">${item}</span>
                <input type="checkbox" class="chk" data-name="${item}">
            </div>
            <input type="file" accept="image/*" capture="camera" class="foto" data-name="${item}">
            <input type="text" class="obs" data-name="${item}" placeholder="Obs...">
        `;
    });

    function salvar() {
        const area = document.getElementById('area').value;
        const resp = document.getElementById('resp').value;
        const aval = document.getElementById('aval').value;

        if(!area || !resp || !aval) return alert("Preencha os campos!");

        const dadosArea = { area, resp, aval, nota: 100, itens: [] };
        const checks = document.querySelectorAll('.chk');
        const fotos = document.querySelectorAll('.foto');
        const obss = document.querySelectorAll('.obs');

        if(document.querySelector('.chk[data-name="Condição Insegura"]').checked) {
            dadosArea.nota = 0;
        } else {
            checks.forEach(c => { if(c.dataset.name !== "Condição Insegura" && !c.checked) dadosArea.nota -= 10; });
        }

        // Aviso de salvamento (sem processar fotos pesado agora para não travar)
        dadosArea.itens = Array.from(checks).map((c, i) => ({
            nome: c.dataset.name,
            ok: c.checked,
            obs: obss[i].value
        }));

        dadosGerais.push(dadosArea);
        document.getElementById('log').innerHTML = `Áreas salvas: ${dadosGerais.length}`;
        alert("Área " + area + " salva!");
        
        // Limpar campos
        document.getElementById('area').value = "";
        checks.forEach(c => c.checked = false);
        obss.forEach(o => o.value = "");
    }

    function gerarPDF() {
        if(dadosGerais.length === 0) return alert("Salve uma área!");
        
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("RELATORIO FAB. RACOES BSB", 10, 10);
            let y = 20;

            dadosGerais.forEach(d => {
                doc.setFontSize(12);
                doc.text(`Area: ${d.area} - Nota: ${d.nota}% - Resp: ${d.resp}`, 10, y);
                y += 10;
                d.itens.forEach(it => {
                    doc.setFontSize(9);
                    doc.text(`${it.ok?'[OK]':'[ ]'} ${it.nome}: ${it.obs}`, 15, y);
                    y += 6;
                    if(y > 280) { doc.addPage(); y = 20; }
                });
                y += 5;
            });

            // Método universal de download para mobile
            doc.save("Relatorio_BSB.pdf");
            alert("O download foi iniciado. Caso não abra, verifique seus downloads e anexe ao WhatsApp.");

        } catch (e) {
            alert("Erro ao criar PDF: " + e.message);
        }
    }
</script>
</body>
</html>
