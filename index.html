<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fab. Rações BSB - Auditoria</title>
    <script src="https://cdnjs.cloudflare.com"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f4f7f9; color: #333; margin: 0; }
        .header-logos { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; border-top: 6px solid #cc0000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-logos img { height: 30px; }
        .card { background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        h3 { color: #cc0000; margin: 0 0 12px 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; font-size: 1.1em; }
        .item-aval { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        input[type="checkbox"] { width: 32px; height: 32px; accent-color: #28a745; }
        input[type="text"], select { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
        #signature-wrapper { position: relative; width: 100%; height: 200px; border: 2px dashed #bbb; border-radius: 10px; background: #fff; touch-action: none; margin-top:10px; }
        #signature-pad { width: 100%; height: 100%; border-radius: 10px; }
        .btn-acao { width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; color: white; }
        .save-btn { background: #004a99; }
        .final-btn { background: #28a745; }
        #loading { display:none; color: #004a99; font-weight: bold; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>

<div class="header-logos">
    <img src="https://upload.wikimedia.org">
    <div style="font-weight: 900; color: #444; font-size: 0.75em; text-align: center;">FAB. RAÇÕES BSB</div>
    <img src="https://upload.wikimedia.org">
</div>

<div class="card">
    <h3>1. Identificação</h3>
    <select id="area">
        <option value="" disabled selected>Selecione a Área (1 a 36)</option>
        <script>for(let i=1;i<=36;i++) document.write(`<option value="${i}">Área ${i}</option>`);</script>
    </select>
    <input type="text" id="responsavel_area" placeholder="Responsável da Área" style="margin-top:10px;">
</div>

<div class="card" id="checklist">
    <h3>2. Itens</h3>
    <script>
        const itensConfig = ["Piso", "Escadas", "Corrimãos", "Portas", "Iluminação", "Equipamentos", "Maquinas", "Organização/Limpeza", "Condição Insegura"];
        itensConfig.forEach(item => {
            document.write(`
                <div class="item-aval">
                    <div class="row">
                        <span style="${item === 'Condição Insegura' ? 'color:red; font-weight:bold;' : ''}">${item}</span>
                        <input type="checkbox" id="check-${item}">
                    </div>
                    <input type="file" accept="image/*" capture="camera" id="img-${item}">
                    <input type="text" id="obs-${item}" placeholder="Observações...">
                </div>
            `);
        });
    </script>
</div>

<div class="card">
    <h3>3. Assinatura</h3>
    <div id="signature-wrapper"><canvas id="signature-pad"></canvas></div>
    <button onclick="signaturePad.clear()" style="width:100%; background:none; border:none; color:blue; margin-top:10px; text-decoration:underline;">Limpar Assinatura</button>
</div>

<div id="loading">PROCESSANDO DADOS... AGUARDE</div>
<button class="btn-acao save-btn" id="btnSalvar" onclick="salvarAvaliacao()">SALVAR ÁREA ATUAL</button>
<button class="btn-acao final-btn" onclick="gerarRelatorioFinal()">GERAR PDF E WHATSAPP</button>

<div class="card" style="text-align:center;">
    <div id="status-ranking">Nenhuma área salva.</div>
    <button onclick="location.reload()" style="margin-top:15px; background:none; border:none; color:gray; text-decoration:underline;">Reiniciar App</button>
</div>

<script>
    let signaturePad;
    const avaliacoesSalvas = [];

    window.onload = function() {
        const canvas = document.getElementById('signature-pad');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
    };

    const toBase64 = file => new Promise((resolve) => {
        if(!file || !file[0]) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(file[0]);
    });

    async function salvarAvaliacao() {
        const areaId = document.getElementById('area').value;
        const resp = document.getElementById('responsavel_area').value;
        
        if(!areaId || !resp) return alert("Preencha Área e Responsável!");

        document.getElementById('loading').style.display = 'block';
        document.getElementById('btnSalvar').disabled = true;

        const dados = {
            nome: "Área " + areaId,
            responsavel: resp,
            data: new Date().toLocaleString('pt-BR'),
            nota: 100,
            itens: [],
            assinatura: signaturePad.isEmpty() ? null : signaturePad.toDataURL()
        };

        // Lógica de Nota
        if(document.getElementById('check-Condição Insegura').checked) {
            dados.nota = 0;
        } else {
            itensConfig.slice(0, -1).forEach(it => {
                if(!document.getElementById(`check-${it}`).checked) dados.nota -= 10;
            });
        }

        // Processar Itens
        for(let it of itensConfig) {
            const inputFoto = document.getElementById(`img-${it}`);
            const fotoBase64 = await toBase64(inputFoto.files);
            
            dados.itens.push({
                nome: it,
                ok: document.getElementById(`check-${it}`).checked,
                obs: document.getElementById(`obs-${it}`).value || "",
                foto: fotoBase64
            });

            // Resetar campos para a próxima área
            document.getElementById(`check-${it}`).checked = false;
            document.getElementById(`obs-${it}`).value = "";
            inputFoto.value = "";
        }

        avaliacoesSalvas.push(dados);
        
        // Resetar Identificação e Assinatura
        document.getElementById('area').value = "";
        document.getElementById('responsavel_area').value = "";
        signaturePad.clear();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('btnSalvar').disabled = false;
        document.getElementById('status-ranking').innerHTML = `<b>Áreas Salvas: ${avaliacoesSalvas.length}</b>`;
        
        alert("✅ Área " + areaId + " salva com sucesso!");
        window.scrollTo(0,0);
    }

    async function gerarRelatorioFinal() {
        if(avaliacoesSalvas.length === 0) return alert("Salve ao menos uma área primeiro!");
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Ranking
        doc.setFontSize(18); doc.setTextColor(200, 0, 0);
        doc.text("FAB. RAÇÕES BSB - JBS/SEARA", 105, 20, {align:"center"});
        
        const sorted = [...avaliacoesSalvas].sort((a,b) => b.nota - a.nota);
        doc.setFontSize(12); doc.setTextColor(0);
        doc.text("RANKING DE PERFORMANCE:", 10, 40);
        sorted.forEach((a, i) => doc.text(`${i+1}. ${a.nome}: ${a.nota}%`, 15, 50+(i*8)));

        // Detalhes
        for(let av of avaliacoesSalvas) {
            doc.addPage();
            doc.setFontSize(16); doc.text(`${av.nome} (${av.nota}%)`, 10, 20);
            doc.setFontSize(10); doc.text(`Resp: ${av.responsavel} | ${av.data}`, 10, 28);
            
            let y = 40;
            for(let it of av.itens) {
                doc.text(`${it.ok?'[OK]':'[ ]'} ${it.nome}: ${it.obs}`, 10, y);
                if(it.foto) { try { doc.addImage(it.foto, 'JPEG', 150, y-5, 40, 25); y+=20; } catch(e){} }
                y += 10;
                if(y > 270) { doc.addPage(); y = 20; }
            }
            if(av.assinatura) doc.addImage(av.assinatura, 'PNG', 10, 250, 40, 20);
        }

        const pdfBlob = doc.output('blob');
        const file = new File([pdfBlob], 'Relatorio_Racoes.pdf', { type: 'application/pdf' });
        
        if (navigator.share) {
            await navigator.share({ files: [file], title: 'Checklist Rações BSB' });
        } else {
            doc.save('Relatorio_Racoes_BSB.pdf');
        }
    }
</script>
</body>
</html>
